{"version":3,"sources":["main.js","js/remote.js","js/sync.js","js/synccomics.js","js/synclist.js","js/utility.js"],"names":["$","loadPage","page","$pageBody","$searchbox","lastPageId","attr","load","responseText","textStatus","jqXHR","pageId","find","window","JSVIEW","destroy","noop","toggle","length","off","ready","hide","empty","swal","title","text","type","initSearchBox","searchEl","minLength","timeout","cb","keyups","Rx","Observable","merge","fromEvent","map","e","target","value","trim","toUpperCase","filter","debounce","distinctUntilChanged","rxSearchForce","rxSearchForceNow","subscribe","defaultPage","onhashchange","location","hash","substr","term","trigger","jQuery","context","click","stopPropagation","preventDefault","action","attributes","message","showCancelButton","confirm","get","then","setTimeout","document","reload","fail","errorThrown","socket","$qrcode","sid","qrcode","width","height","WebSocket","host","onerror","error","console","log","onmessage","event","data","JSON","parse","synced","href","show","clearInterval","hnd","close","on","arrTerms","split","rg","RegExp","replace","index","el","matches","match","_","difference","fomratters","datetime","moment","format","status","0","1","3","each","innerHTML","innerText","capitalize","closeOnConfirm","post","lastSync","Date","now","String","prototype","this","charAt","slice"],"mappings":"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","file":"all.min.js","sourcesContent":["($ => {\n    // oggetto che andra' a contenere i riferimeti ai JS di tutte le pagine\n    window.JSVIEW = {\n        // \"page_name\": {\n        //     \"ready\": function(context) {},\n        //     \"destroy\": function(context) {}\n        // }\n        // sul contesto (context) possono essere registarti i seguenti eventi:\n        // - searchbox:search\n    };\n\n    /**\n     * Carica la pagina specificata da \"page\"\n     *\n     * @param      {string}   page    nome della pagina da caricare\n     */\n    function loadPage(page) {\n        const $pageBody = $('.page-body');\n        const $searchbox = $('.searchbox');\n        const lastPageId = $pageBody.attr('data-page-id');\n        $pageBody.load('/' + page,\n            (responseText, textStatus, jqXHR) => {\n                if (textStatus === 'success') {\n                    // chiave dello script da eseguire\n                    const pageId = $pageBody.find('.page').attr('data-page-id');\n                    if (!pageId) {\n                        $searchbox.hide();\n                        $pageBody.empty();\n                        swal({ title: 'Page id not found', text: 'The page script can not be executed', type: 'error' });\n                    } else {\n                        // scarico la pagina corrente                    \n                        lastPageId && window.JSVIEW[lastPageId] && (window.JSVIEW[lastPageId].destroy || $.noop)($pageBody);\n                        // mostro o nascondo la barra di ricerca in base alla classe .with-searchbox\n                        $searchbox.toggle(!!$pageBody.find('.page.with-searchbox').length);\n                        // elimino gli eventi legati al contesto\n                        $pageBody.off('searchbox:search');\n                        // lancio lo script della pagina caricata\n                        $pageBody.attr('data-page-id', pageId);\n                        window.JSVIEW[pageId] && (window.JSVIEW[pageId].ready || $.noop)($pageBody);\n                    }\n                } else {\n                    $searchbox.hide();\n                    $pageBody.empty();\n                    swal({ title: 'Page not found', text: page, type: 'error' });\n                }\n            });\n    }\n\n    /**\n     * Inizializza la barra di ricerca.\n     * Al cambiamento del valore di ricerca viene eseguito cb(<termine ricerca>)\n     *\n     * @param      {Element}    searchEl   l'elemento HTML\n     * @param      {number}     minLength  numero minimo di caratteri per scatenare la ricerca\n     * @param      {number}     timeout    quanto tempo (in ms) deve passare prima di scatenare la ricerca (debounce)\n     * @param      {Function}   cb         { term: termine della ricerca }\n     */\n    function initSearchBox(searchEl, minLength, timeout, cb) {\n        // eventi sulla casella di ricerca (tasto premuto e perdita focus)\n        const keyups = Rx.Observable.merge(\n                Rx.Observable.fromEvent(searchEl, 'keyup'),\n                Rx.Observable.fromEvent(searchEl, 'blur'))\n            .map(e => e.target.value.trim().toUpperCase())\n            .filter(text => text.length === 0 || text.length >= minLength)\n            .debounce(timeout) //se non cambia piu' niente per 500ms prosegue\n            .distinctUntilChanged(); //esclude gli eventi diversi\n        const rxSearchForce = Rx.Observable.fromEvent(searchEl, 'rx-search-force')\n            .map(e => e.target.value.trim())\n            .debounce(timeout); //se non cambia piu' niente per 500ms prosegue\n        const rxSearchForceNow = Rx.Observable.fromEvent(searchEl, 'rx-search-force-now')\n            .map(e => e.target.value.trim());\n        //\n        Rx.Observable.merge(keyups, rxSearchForce, rxSearchForceNow)\n            .subscribe(cb);\n    }\n\n    $(() => {\n        // pagina di default\n        const defaultPage = 'sync';\n        // evento scatenato al cambio della parte hash\n        window.onhashchange = (() => {\n            loadPage(location.hash.substr(1) || defaultPage);\n        });\n        // inizializzo la barra di ricerca\n        initSearchBox($('.searchbox>input'), 3, 500, (term) => {\n            $('.page-body').trigger('searchbox:search', term);\n        });\n        // se non ci sono pagine specificate nell'hash, carico una pagina di default\n        loadPage(location.hash.substr(1) || defaultPage);\n    });\n})(jQuery);\n","($ => {\n    window.JSVIEW['remote'] = {\n        ready: (context) => {\n            $('button[data-action]', context).click(e => {\n                e.stopPropagation();\n                e.preventDefault();\n\n                const action = e.target.attributes['data-action'].value;\n                const title = e.target.attributes['data-confirm-title'].value;\n                const message = e.target.attributes['data-confirm-message'].value;\n\n                swal({\n                        title: title,\n                        text: message,\n                        showCancelButton: true\n                    },\n                    confirm => {\n                        if (confirm) {\n                            $.get('/remote/' + action).then(() => {\n                                // ritardo il refresh altrimenti rischio che il comando non sia stato ancora eseguito\n                                setTimeout(() => { document.location.reload(true); }, 500);\n                            }).fail((jqXHR, textStatus, errorThrown) => {\n                                swal({ title: 'Load processes', text: textStatus + ': ' + errorThrown, type: 'error' });\n                            });\n                        }\n                    });\n            });\n        }\n    }\n})(jQuery);\n","($ => {\n    let socket;\n\n    window.JSVIEW['sync'] = {\n        ready: (context) => {\n            const $qrcode = $('#qrcode', context);\n            const sid = $qrcode.attr('data-sid');\n            // renderizzo il sid passato con la pagina\n            $qrcode\n                .qrcode({\n                    width: 256,\n                    height: 256,\n                    text: sid\n                });\n            // pulsante per reload pagina\n            $('#btnNewCode', context).click(e => {\n                document.location.reload();\n            });\n            // creo un web socket per controllare lo stato del sid\n            socket = new WebSocket('ws://' + location.host +'/sync/wsh/' + sid);\n            // socket.onopen = (event) => {\n            //     console.log(event);\n            // };\n            socket.onerror = (error) => {\n                console.log(error);\n            };\n            socket.onmessage = (event) => {\n                const data = JSON.parse(event.data);\n                if (data.synced) {\n                    // carico la pagina per l'editing dei dati\n                    document.location.href = '#sync/comics/' + sid;\n                } else {\n                    $qrcode.hide();\n                    $('#btnNewCode', context).show()\n                    clearInterval(hnd);\n                    socket.close();\n                }\n            };\n        },\n        destroy: (context) => {\n            socket.close();\n        }\n    }\n})(jQuery);\n","($ => {\n    window.JSVIEW['synccomics'] = {\n        ready: (context) => {\n        \t// registro l'evento per la ricerca\n            context.on('searchbox:search', (event, term) => {\n            \tif (term) {\n\t\t\t\t\tconst arrTerms = term.split(/\\s/);\n            \t\tconst termCount = arrTerms.length;\n\t\t\t\t\tconst rg = new RegExp('(' + term.replace(/\\s/g, '|') + ')', 'gi');\n\t\t\t\t\t$('.comics-list>.comics').hide()\n\t\t\t\t\t\t.filter((index, el) => {\n\t\t\t\t\t\t\t// tutti i termini della ricerca devono essere trovati\n\t\t\t\t\t\t\tconst matches = el.attributes['data-search'].value.match(rg);\n\t\t\t\t\t\t\treturn (matches && (_.difference(arrTerms, matches).length === 0));\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.show();\n            \t} else {\n            \t\t$('.comics-list>.comics').show();\n            \t}\n            });\n        }\n    }\n})(jQuery);\n","($ => {\n    const fomratters = {\n        'datetime': value => moment(+value).format('YYYY-MM-DD HH:mm:ss'),\n        'status': value => fomratters[value] || value,\n        '0': 'NO_SYNC',\n        '1': 'SYNCED',\n        '3': 'DATA_RECEIVED'\n    }\n\n    window.JSVIEW['synclist'] = {\n        ready: (context) => {\n            $('[data-format]', context).each((index, el) => {\n                el.innerHTML = fomratters[el.attributes['data-format'].value](el.innerText);\n            });\n\n            $('a[data-action]', context).click(e => {\n                e.stopPropagation();\n                e.preventDefault();\n\n                const action = e.target.attributes['data-action'].value;\n                const sid = e.target.attributes['data-sid'].value;\n\n                swal({\n                        title: action.capitalize() + ' ' + sid + '?',\n                        showCancelButton: true,\n                        closeOnConfirm: true\n                    },\n                    confirm => {\n                        if (confirm) {\n                            setTimeout(() => {\n                                if (action === 'sync') {\n                                    $.post('/sync/' + sid).then(() => {\n                                        location.reload();\n                                    }).fail((jqXHR, textStatus, errorThrown) => {\n                                        swal({ title: 'Sync', text: textStatus + ': ' + errorThrown, type: 'error' });\n                                    });\n                                } else if (action === 'expire') {\n                                    $.post('/sync/change/' + sid, { 'lastSync': Date.now() - 30000 }).then(() => {\n                                        location.reload();\n                                    }).fail((jqXHR, textStatus, errorThrown) => {\n                                        swal({ title: 'Expire', text: textStatus + ': ' + errorThrown, type: 'error' });\n                                    });\n                                } else if (action === 'remove') {\n                                    $.post('/sync/remove/' + sid).then(() => {\n                                        location.reload();\n                                    }).fail((jqXHR, textStatus, errorThrown) => {\n                                        swal({ title: 'Remove', text: textStatus + ': ' + errorThrown, type: 'error' });\n                                    });                                    \n                                }\n                            }, 100);\n                        }\n                    });\n            });\n        }\n    }\n})(jQuery);\n","String.prototype.capitalize = function() {\n\treturn this.charAt(0).toUpperCase() + this.slice(1);\n};"],"sourceRoot":"/source/"}